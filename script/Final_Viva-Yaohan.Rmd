---
title: "Final Assignment"
author: "Viva/Yaohan"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: flatly
    toc_float: yes
    code_folding: hide
    number_sections: no
  pdf_document:
    toc: yes
---

<style>
.kable thead tr th, .table thead tr th {
  text-align: left !important;}
table.kable, table.table {
  width: 100% !important;}
  body {
  line-height: 1.6;
  font-size: 16px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dpi = 150)
options(scipen = 999)

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, sf, units, nngeo, tmap, tinytex, kableExtra, janitor, classInt,lehdr,
       patchwork, here, tidycensus, lwgeom, lsr, haven, descr, RColorBrewer, stargazer,
       car, FNN, GGally, MASS, ISLR2, spdep, caret, ckanr, grid, gridExtra, ggcorrplot,
       jtools, broom, tufte, rmarkdown, corrr, RSocrata, viridis, spatstat, raster, knitr,
       arm, mlogit, readxl, lubridate)

library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)
conflicts_prefer(sf::st_crs)
```


# Data Preparation

1. Transit Data
- Transit Ridership
MBTA Rail Ridership by Time Period, Season, Route/Line, and Stop: https://mbta-massdot.opendata.arcgis.com/search?tags=ridership
The data is for Fall2019, Fall2018, and Fall2017. Since Fall2018 only has data for September, so we only use ridership data for Fall2019 and Fall2017.

- Transit Station
MBTA Rapid Transit: https://www.mass.gov/info-details/massgis-data-mbta-rapid-transit#downloads-
Name and location for each transit stopï¼› Combined with ridership data.

- Service Delivery Policy
Definition for "Fall" in MassDOT: https://www.mass.gov/doc/controls-guidelines-attachment-a-important-work-restrictions/download
The Fall season defined by MassDOT is from August.15 to November.1, so we use bike data for August, September and October.
Definition for "Time Period" in MassDOT: https://cdn.mbta.com/sites/default/files/2021-09/service-delivery-policy-june-2021.pdf

2. Bike Data
- Bike Ridership
Blue Bikes Comprehensive Trip Histories: https://s3.amazonaws.com/hubway-data/index.html
2017: August, September, October
2019: August, September, October

- Bike Station
Bluebikes Stations: https://bluebikes.com/system-data

3. Bus Data
MBTA Bus Routes and Stops: https://www.mass.gov/info-details/massgis-data-mbta-bus-routes-and-stops?_gl=1*1iy371g*_ga*MTQzMTUzMDg3Mi4xNzA4MTExODY2*_ga_MCLPEGW7WM*MTcxMzg4OTY1OC4xLjEuMTcxMzg4OTY4MS4wLjAuMA..#overview-

4. MBTA Boundary
MBTA Core Service Area: https://mbta-massdot.opendata.arcgis.com/search?q=boundary

5. LEHD and ACS Data
https://lehd.ces.census.gov/data/
https://data.census.gov/

7. CRS
NAD83 / Massachusetts Mainland (ftUS)
https://epsg.io/2249

## Import Datasets

```{r load_data, message = FALSE, warning = FALSE}
# Transit Data
## Transit Ridership
tran_rider <- read_csv(here::here("data/final/Transit_Ridership.csv"))
## Transit Station
tran_line <- st_read(here::here("data/final/mbta_rapid_transit/MBTA_ARC.shp")) %>%
  st_transform(crs = 2249)
tran_stop <- st_read(here::here("data/final/mbta_rapid_transit/MBTA_NODE.shp")) %>%
  st_transform(crs = 2249)


# Bike Data
## Bike Ridership
bike_rider_17_aug <- read_csv(here::here("data/final/201708-hubway-tripdata.csv"))
bike_rider_17_sep <- read_csv(here::here("data/final/201709-hubway-tripdata.csv"))
bike_rider_17_oct <- read_csv(here::here("data/final/201710-hubway-tripdata.csv"))
bike_rider_19_aug <- read_csv(here::here("data/final/201908-bluebikes-tripdata.csv"))
bike_rider_19_sep <- read_csv(here::here("data/final/201909-bluebikes-tripdata.csv"))
bike_rider_19_oct <- read_csv(here::here("data/final/201910-bluebikes-tripdata.csv"))
## Bike Station
bike_stop <- read_csv(here::here("data/final/current_bluebikes_stations.csv"))


# Bus Data
## Bus Stop
bus_stop <- st_read(here::here("data/final/mbtabus/MBTABUSSTOPS_PT.shp")) %>%
  st_transform(crs = 2249)


# Other Data
## MBTA Boundary
mbta_core <- st_read(here::here("data/final/Core_Service_Area/Core_Service_Area.shp")) %>%
  st_transform(crs = 2249)

# Set Search Radius
radius <- c(1320)
```


# Data Wrangling

## MBTA Boundary

```{r boundary}
mbta_core <- mbta_core %>%
  st_union() %>%
  st_as_sf()
```

## Transit Data

```{r transit}
## Align Station Name between Two Datasets
tran_rider <- tran_rider %>%
  mutate(stop_name = case_when(
    stop_name == "Back of the Hill" ~ "Back Of The Hill",
    stop_name == "Boston Univ. Central" ~ "Boston University Central",
    stop_name == "Boston Univ. East" ~ "Boston University East",
    stop_name == "Boston Univ. West" ~ "Boston University West",
    stop_name == "Chestnut Hill Ave." ~ "Chestnut Hill Avenue",
    stop_name == "Englewood Ave." ~ "Englewood Avenue",
    stop_name == "Harvard Ave." ~ "Harvard Avenue",
    stop_name == "JFK/Umass" ~ "JFK/UMass",
    stop_name == "Massachusetts Ave." ~ "Massachusetts Ave",
    stop_name == "Museum of Fine Arts" ~ "Museum Of Fine Arts",
    stop_name == "Northeastern University" ~ "Northeastern",
    stop_name == "Saint Mary Street" ~ "Saint Marys Street",
    stop_name == "Science Park" ~ "Science Park/West End",
    stop_name == "State Street" ~ "State",
    stop_name == "Summit Ave." ~ "Summit Avenue",
    TRUE ~ stop_name))

name_rider <- unique(tran_rider$stop_name)
name_stop <- tran_stop$STATION
not_in_station <- as.data.frame(setdiff(name_rider, name_stop))

## Transit Ridership
tran_rider <- tran_rider %>%
  mutate(time_period = paste(day_type_name, time_period_name, sep = "_"))

tran_stop <- tran_stop %>%
  filter(LINE != "SILVER") ## Silver Line is BRT

### Transit Ridership by Time Period
tran_rider_17_period <- tran_rider %>%
  filter(season == "Fall 2017") %>%
  group_by(stop_name, time_period) %>%
  summarise(aver_ons = sum(average_ons),
            aver_offs = sum(average_offs)) %>%
  ungroup() %>%
  mutate(total_rider_tran = aver_ons + aver_offs) %>%
  left_join(., tran_stop, by = c("stop_name" = "STATION")) %>%
  na.omit() %>%
  select(-aver_ons, -aver_offs, -LINE, -ROUTE) %>%
  rename(tran_stop = stop_name, terminus = TERMINUS) %>%
  st_as_sf()

tran_rider_19_period <- tran_rider %>%
  filter(season == "Fall 2019") %>%
  group_by(stop_name, time_period) %>%
  summarise(aver_ons = sum(average_ons),
            aver_offs = sum(average_offs)) %>%
  ungroup() %>%
  mutate(total_rider_tran = aver_ons + aver_offs) %>%
  left_join(., tran_stop, by = c("stop_name" = "STATION")) %>%
  na.omit() %>%
  select(-aver_ons, -aver_offs, -LINE, -ROUTE) %>%
  rename(tran_stop = stop_name, terminus = TERMINUS) %>%
  st_as_sf()

### Total Transit Ridership
tran_rider_17_total <- tran_rider_17_period %>%
  st_drop_geometry() %>%
  group_by(tran_stop) %>%
  summarise(total_rider_tran = sum(total_rider_tran)) %>%
  ungroup() %>%
  left_join(., tran_stop, by = c("tran_stop" = "STATION")) %>%
  na.omit() %>%
  select(-LINE, -ROUTE) %>%
  rename(terminus = TERMINUS) %>%
  st_as_sf()

tran_rider_19_total <- tran_rider_19_period %>%
  st_drop_geometry() %>%
  group_by(tran_stop) %>%
  summarise(total_rider_tran = sum(total_rider_tran)) %>%
  ungroup() %>%
  left_join(., tran_stop, by = c("tran_stop" = "STATION")) %>%
  na.omit() %>%
  select(-LINE, -ROUTE) %>%
  rename(terminus = TERMINUS) %>%
  st_as_sf()
```

## 2017 Bike Data

```{r bike_2017}
## Bike Station
colnames(bike_stop) <- as.character(unlist(bike_stop[1, ]))
bike_stop <- bike_stop[-1, ] %>%
  select(name = NAME,
         total_docks = `Total Docks`) %>%
  rename(bike_stop = name)

## Combine 2017
bike_rider_17 <- bind_rows(bike_rider_17_aug, bike_rider_17_sep, bike_rider_17_oct)
sum(duplicated(bike_rider_17))

### Start Trips
bike_rider_17_start <- bike_rider_17 %>%
  separate(col = starttime, into = c("date", "time"), sep = " ") %>%
  mutate(day_type_name = case_when(
      wday(date, label = TRUE, week_start = 1) %in% c("Sat") ~ "saturday",
      wday(date, label = TRUE, week_start = 1) %in% c("Sun") ~ "sunday",
      TRUE ~ "weekday")) %>%
  mutate(time_period_name = case_when(
      time >= "03:00:00" & time < "06:00:00" ~ "VERY_EARLY_MORNING",
      time >= "06:00:00" & time < "07:00:00" ~ "EARLY_AM",
      time >= "07:00:00" & time < "09:00:00" ~ "AM_PEAK",
      time >= "09:00:00" & time < "13:30:00" ~ "MIDDAY_BASE",
      time >= "13:30:00" & time < "16:00:00" ~ "MIDDAY_SCHOOL",
      time >= "16:00:00" & time < "18:30:00" ~ "PM_PEAK",
      time >= "18:30:00" & time < "22:00:00" ~ "EVENING",
      time >= "22:00:00" & time < "24:00:00" ~ "LATE_EVENING",
      time >= "00:00:00" & time < "03:00:00" ~ "NIGHT",
      TRUE ~ NA)) %>%
  mutate(time_period_change = case_when(
  day_type_name %in% c("saturday", "sunday") ~ "OFF_PEAK",
  TRUE ~ time_period_name)) %>%
  mutate(time_period = paste(day_type_name, time_period_change, sep = "_")) %>%
  group_by(time_period, `start station name`) %>%
  summarise(Start_Trip_17 = n()) %>%
  ungroup() %>%
  rename(bike_stop = `start station name`)

### End Trips
bike_rider_17_end <- bike_rider_17 %>%
  separate(col = stoptime, into = c("date", "time"), sep = " ") %>%
  mutate(day_type_name = case_when(
      wday(date, label = TRUE, week_start = 1) %in% c("Sat") ~ "saturday",
      wday(date, label = TRUE, week_start = 1) %in% c("Sun") ~ "sunday",
      TRUE ~ "weekday")) %>%
  mutate(time_period_name = case_when(
      time >= "03:00:00" & time < "06:00:00" ~ "VERY_EARLY_MORNING",
      time >= "06:00:00" & time < "07:00:00" ~ "EARLY_AM",
      time >= "07:00:00" & time < "09:00:00" ~ "AM_PEAK",
      time >= "09:00:00" & time < "13:30:00" ~ "MIDDAY_BASE",
      time >= "13:30:00" & time < "16:00:00" ~ "MIDDAY_SCHOOL",
      time >= "16:00:00" & time < "18:30:00" ~ "PM_PEAK",
      time >= "18:30:00" & time < "22:00:00" ~ "EVENING",
      time >= "22:00:00" & time < "24:00:00" ~ "LATE_EVENING",
      time >= "00:00:00" & time < "03:00:00" ~ "NIGHT",
      TRUE ~ NA)) %>%
  mutate(time_period_change = case_when(
  day_type_name %in% c("saturday", "sunday") ~ "OFF_PEAK",
  TRUE ~ time_period_name)) %>%
  mutate(time_period = paste(day_type_name, time_period_change, sep = "_")) %>%
  group_by(time_period, `end station name`) %>%
  summarise(End_Trip_17 = n()) %>%
  ungroup() %>%
  rename(bike_stop = `end station name`)

### 2017 Bike Stops
sum(unique(bike_rider_17_start$bike_stop) %in% unique(bike_rider_17_end$bike_stop))
bike_stop_17 <- bike_rider_17 %>%
  select(Name = `start station name`,
         Long = `start station longitude`,
         Lat = `start station latitude`) %>%
  group_by(Name, Long, Lat) %>%
  tally() %>%
  ungroup() %>%
  select(-n) %>%
  distinct(Name, .keep_all = TRUE) %>%
  filter(Lat != 0 & Long != 0) %>%
  rename(bike_stop = Name)

### 2017 Total Trips
bike_rider_17_period <- bike_rider_17_start %>%
  left_join(., bike_rider_17_end, by = c("bike_stop", "time_period")) %>%
  mutate(total_rider_bike = Start_Trip_17 + End_Trip_17) %>%
  left_join(bike_stop_17, ., by = "bike_stop") %>%
  na.omit() %>%
  st_as_sf(coords = c("Long", "Lat"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(bike_stop, time_period, total_rider_bike) %>%
  left_join(., bike_stop, by = "bike_stop") %>%
  mutate(total_docks = as.numeric(total_docks)) %>%
  mutate(total_docks = replace_na(total_docks,
                                  floor(mean(total_docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(total_docks, .before = geometry)

bike_rider_17_total <- bike_rider_17_period %>%
  group_by(bike_stop) %>%
  summarise(total_rider_bike = sum(total_rider_bike)) %>%
  ungroup() %>%
  left_join(., bike_stop, by = "bike_stop") %>%
  mutate(total_docks = as.numeric(total_docks)) %>%
  mutate(total_docks = replace_na(total_docks,
                                  floor(mean(total_docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(total_docks, .before = geometry)
```

## 2019 Bike Data

```{r bike_2019}
## Combine 2019
bike_rider_19 <- bind_rows(bike_rider_19_aug, bike_rider_19_sep, bike_rider_19_oct)
sum(duplicated(bike_rider_19))

### Start Trips
bike_rider_19_start <- bike_rider_19 %>%
  separate(col = starttime, into = c("date", "time"), sep = " ") %>%
  mutate(day_type_name = case_when(
      wday(date, label = TRUE, week_start = 1) %in% c("Sat") ~ "saturday",
      wday(date, label = TRUE, week_start = 1) %in% c("Sun") ~ "sunday",
      TRUE ~ "weekday")) %>%
  mutate(time_period_name = case_when(
      time >= "03:00:00" & time < "06:00:00" ~ "VERY_EARLY_MORNING",
      time >= "06:00:00" & time < "07:00:00" ~ "EARLY_AM",
      time >= "07:00:00" & time < "09:00:00" ~ "AM_PEAK",
      time >= "09:00:00" & time < "13:30:00" ~ "MIDDAY_BASE",
      time >= "13:30:00" & time < "16:00:00" ~ "MIDDAY_SCHOOL",
      time >= "16:00:00" & time < "18:30:00" ~ "PM_PEAK",
      time >= "18:30:00" & time < "22:00:00" ~ "EVENING",
      time >= "22:00:00" & time < "24:00:00" ~ "LATE_EVENING",
      time >= "00:00:00" & time < "03:00:00" ~ "NIGHT",
      TRUE ~ NA)) %>%
  mutate(time_period_change = case_when(
  day_type_name %in% c("saturday", "sunday") ~ "OFF_PEAK",
  TRUE ~ time_period_name)) %>%
  mutate(time_period = paste(day_type_name, time_period_change, sep = "_")) %>%
  group_by(time_period, `start station name`) %>%
  summarise(Start_Trip_19 = n()) %>%
  ungroup() %>%
  rename(bike_stop = `start station name`)

### End Trips
bike_rider_19_end <- bike_rider_19 %>%
  separate(col = stoptime, into = c("date", "time"), sep = " ") %>%
  mutate(day_type_name = case_when(
      wday(date, label = TRUE, week_start = 1) %in% c("Sat") ~ "saturday",
      wday(date, label = TRUE, week_start = 1) %in% c("Sun") ~ "sunday",
      TRUE ~ "weekday")) %>%
  mutate(time_period_name = case_when(
      time >= "03:00:00" & time < "06:00:00" ~ "VERY_EARLY_MORNING",
      time >= "06:00:00" & time < "07:00:00" ~ "EARLY_AM",
      time >= "07:00:00" & time < "09:00:00" ~ "AM_PEAK",
      time >= "09:00:00" & time < "13:30:00" ~ "MIDDAY_BASE",
      time >= "13:30:00" & time < "16:00:00" ~ "MIDDAY_SCHOOL",
      time >= "16:00:00" & time < "18:30:00" ~ "PM_PEAK",
      time >= "18:30:00" & time < "22:00:00" ~ "EVENING",
      time >= "22:00:00" & time < "24:00:00" ~ "LATE_EVENING",
      time >= "00:00:00" & time < "03:00:00" ~ "NIGHT",
      TRUE ~ NA)) %>%
  mutate(time_period_change = case_when(
  day_type_name %in% c("saturday", "sunday") ~ "OFF_PEAK",
  TRUE ~ time_period_name)) %>%
  mutate(time_period = paste(day_type_name, time_period_change, sep = "_")) %>%
  group_by(time_period, `end station name`) %>%
  summarise(End_Trip_19 = n()) %>%
  ungroup() %>%
  rename(bike_stop = `end station name`)

### 2019 Bike Stops
sum(unique(bike_rider_19_start$bike_stop) %in% unique(bike_rider_19_end$bike_stop))
stop_17 <- unique(bike_rider_17_total$bike_stop)
bike_stop_19 <- bike_rider_19 %>%
  select(Name = `end station name`,
         Long = `end station longitude`,
         Lat = `end station latitude`) %>%
  group_by(Name, Long, Lat) %>%
  tally() %>%
  ungroup() %>%
  select(-n) %>%
  distinct(Name, .keep_all = TRUE) %>%
  filter(Lat != 0 & Long != 0) %>%
  rename(bike_stop = Name) %>%
  mutate(new_stop = ifelse(bike_stop %in% stop_17, 0, 1))
table(bike_stop_19$new_stop)

### 2019 Total Trips
bike_rider_19_period <- bike_rider_19_start %>%
  left_join(., bike_rider_19_end, by = c("bike_stop", "time_period")) %>%
  mutate(total_rider_bike = Start_Trip_19 + End_Trip_19) %>%
  left_join(bike_stop_19, ., by = "bike_stop") %>%
  na.omit() %>%
  st_as_sf(coords = c("Long", "Lat"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(bike_stop, time_period, total_rider_bike) %>%
  left_join(., bike_stop, by = "bike_stop") %>%
  mutate(total_docks = as.numeric(total_docks)) %>%
  mutate(total_docks = replace_na(total_docks,
                                  floor(mean(total_docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(total_docks, .before = geometry)

bike_rider_19_total <- bike_rider_19_period %>%
  group_by(bike_stop) %>%
  summarise(total_rider_bike = sum(total_rider_bike)) %>%
  ungroup() %>%
  left_join(., bike_stop, by = "bike_stop") %>%
  mutate(total_docks = as.numeric(total_docks)) %>%
  mutate(total_docks = replace_na(total_docks,
                                  floor(mean(total_docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(total_docks, .before = geometry)
```

## Bus Data

```{r bus}
## Bus Stop
bus_stop <- bus_stop %>%
  select(STOP_NAME) %>%
  rename(bus_stop = STOP_NAME) %>%
  distinct(bus_stop, .keep_all = TRUE)

rm(list = setdiff(ls(), c("tran_line", "tran_stop", "tran_rider_17_period", "tran_rider_17_total",
                          "tran_rider_19_period", "tran_rider_19_total", "bike_rider_17_period",
                          "bike_rider_17_total", "bike_rider_19_period", "bike_rider_19_total",
                          "bus_stop", "mbta_core", "radius")))
```

## LEHD and ACS data

**Built Environment Variables**
- Total population 
- Population density 
- Total Commuting Workers
- Total Occupied House Unit 
- Housing density 
- Total Employment
- Employment density

**Socioeconomic Variables**
- non-white share
- commute in vehicles share
- commute in bus share
- commute by subway share
- commute by rail share
- commute by trolley share
- commute by bike share
- vehicle ownership for workers
- household median income
- poverty rate
- labor force participation rate
- employment rate

```{r LEHD}
# LEHD data - 2017
job.2017 <- grab_lodes(state = "ma", year = 2017, 
                    lodes_type = "wac", # wac, Workplace Area Characteristic data, jobs are totaled by work Census Block
                    job_type = "JT01", #primary jobs
                    segment = "S000", #total jobs
                    state_part = "main", #both worklace and residence in-state
                    agg_geo = "bg",
                    download_dir = file.path("data/raw"))%>%
  select(w_bg,C000)%>%
  rename(job = C000)

# LEHD data - 2019
job.2019<- grab_lodes(state = "ma", year = 2019, 
                    lodes_type = "wac", # wac, Workplace Area Characteristic data, jobs are totaled by work Census Block
                    job_type = "JT01", #primary jobs
                    segment = "S000", #total jobs
                    state_part = "main", #both worklace and residence in-state
                    agg_geo = "bg",
                    download_dir = file.path("data/raw"))%>%
  select(w_bg,C000)%>%
  rename(job = C000)
```


```{r acs.var}
census_api_key("3ec2bee8c227ff3f9df970d0ffbb11ee1384076e", install = TRUE, overwrite = TRUE)
readRenviron("~/.Renviron")

# get variables
acs_variable_list.2017 <- load_variables(2017, "acs5")%>%
  filter(geography == 'block group')

acs.var <- c('B01001_001E',#total population
             #-> non-white share
             'B03002_003E',#White Non-Hispanic
             #-> commute mode share
             'B08301_001E',#Workers 16 years and over
             'B08301_002E',#Car, truck, or van
             'B08301_011E',#Bus
             'B08301_012E',#Subway or elevated rail
             'B08301_013E',#Long-distance train or commuter rail
             'B08301_014E',#Streetcar or trolley car
             'B08301_018E',#cyclists
             'B08301_021E',#working form home
             #-> vehicle ownership for household
             'B25044_001E',#Occupied housing units
             'B25044_003E',#No vehicle available for owned units
             'B25044_010E',#No vehicle available for rented units
             #-> household median income
             'B19013_001E',#median income for household
             #-> poverty rate
             'B17017_002E',#Income in the past 12 months below poverty level
              #-> labor force participation rate
             'B23025_001E',#Population 16 years and over
             'B23025_002E',#In labor force
             #-> employment rate
             'B23025_003E',#Civilian labor force
             'B23025_004E')#population employed

```


```{r acs2017}
#get 2017 data
acs.2017 <- get_acs(geography = "block group",
                    year = 2017,
                    variables = acs.var,
                    geometry = TRUE,
                    survey = "acs5",
                    state = "MA",
                    output = "wide")%>%
  st_transform(crs = 2249) %>%
  select(GEOID, all_of(acs.var)) %>%
  rename(pop.tot = B01001_001E,
         pop.white = B03002_003E, 
         
         com.tot = B08301_001E, 
         com.car = B08301_002E, 
         com.bus = B08301_011E, 
         com.sub = B08301_012E, 
         com.rail = B08301_013E, 
         com.trolley = B08301_014E, 
         com.bike = B08301_018E,
         com.home = B08301_021E,
      
         hh.tot = B25044_001E,
         hh.noveh.own = B25044_003E,
         hh.noveh.rent = B25044_010E,
        
         medInc = B19013_001E,
        
         hh.pover = B17017_002E,
       
         pop.16 = B23025_001E, 
         pop.labor = B23025_002E, 
        
         pop.civil = B23025_003E,
         pop.emp = B23025_004E)%>%
  mutate(area = st_area(.)) %>%
  mutate(area = set_units(x = area, value = "acres"))%>%
  left_join(job.2017, by = c('GEOID'='w_bg'))# join job
```



```{r acs2019}
#get 2019 data
acs.2019 <- get_acs(geography = "block group",
                    year = 2019,
                    variables = acs.var,
                    geometry = TRUE,
                    survey = "acs5",
                    state = "MA",
                    output = "wide")%>%
  st_transform(crs = 2249) %>%
  select(GEOID, all_of(acs.var)) %>%
  rename(pop.tot = B01001_001E,
         pop.white = B03002_003E, 
         
         com.tot = B08301_001E, 
         com.car = B08301_002E, 
         com.bus = B08301_011E, 
         com.sub = B08301_012E, 
         com.rail = B08301_013E, 
         com.trolley = B08301_014E, 
         com.bike = B08301_018E,
         com.home = B08301_021E,
      
         hh.tot = B25044_001E,
         hh.noveh.own = B25044_003E,
         hh.noveh.rent = B25044_010E,
        
         medInc = B19013_001E,
        
         hh.pover = B17017_002E,
       
         pop.16 = B23025_001E, 
         pop.labor = B23025_002E, 
        
         pop.civil = B23025_003E,
         pop.emp = B23025_004E)%>%
  mutate(area = st_area(.)) %>%
  mutate(area = set_units(x = area, value = "acres"))%>%
  left_join(job.2019, by = c('GEOID'='w_bg')) #join job data
```


```{r acs-join-2017}
## 2017
# value
acs.2017.stop.dot <- tran_stop %>%
  st_join(acs.2017)%>%
  mutate(pop.den = round(ifelse(as.numeric(area) > 0, pop.tot / area, 0),digits = 2),
         hh.den = round(ifelse(as.numeric(area) > 0, hh.tot / area, 0),digits = 2),
         commuter.tot = com.tot-com.home,
         white.share = round(ifelse(pop.tot > 0, pop.white / pop.tot, 0) * 100, digits = 2),
         car.share = round(ifelse(com.tot > 0, com.car / (com.tot-com.home), 0)*100, digits = 2),
         bus.share = round(ifelse(com.tot > 0, com.bus / (com.tot-com.home), 0)*100, digits = 2),
         sub.share = round(ifelse(com.tot > 0, com.sub / (com.tot-com.home), 0)*100, digits = 2),
         rail.share = round(ifelse(com.tot > 0, com.rail / (com.tot-com.home), 0)*100, digits = 2),
         tro.share = round(ifelse(com.tot > 0, com.trolley / (com.tot-com.home), 0)*100, digits = 2),
         bike.share = round(ifelse(com.tot > 0, com.bike / (com.tot-com.home), 0)*100, digits = 2),
         tran.share = round(ifelse(com.tot > 0, (com.sub+com.rail+com.trolley) / (com.tot-com.home), 0)*100, digits = 2),
         veh.ownership = round(ifelse(hh.tot > 0, (hh.noveh.own+hh.noveh.rent) / hh.tot, 0)*100, digits = 2),
         pover.rate = round(ifelse(hh.tot > 0, hh.pover / hh.tot, 0)*100, digits = 2),
         labor.rate = round(ifelse(pop.16 > 0, pop.labor / pop.16, 0)*100, digits = 2),
         employ.rate = round(ifelse(pop.civil > 0, pop.emp / pop.civil, 0)*100, digits = 2),
         job.den = round(ifelse(as.numeric(area) > 0, job / area, 0),digits = 2))%>%
  select(STATION,GEOID,
         pop.tot,pop.den,commuter.tot,
         hh.tot,hh.den,
         job,job.den,
         white.share,
         car.share,bus.share,sub.share,rail.share,tro.share,bike.share,tran.share,
         veh.ownership,
         medInc, pover.rate,
         labor.rate,employ.rate)

# buffer- average value 
columns_to_sum <- setdiff(names(acs.2017), c("GEOID", "geometry"))
acs.2017.stop.buffer <- tran_stop %>%
  st_buffer(radius) %>%
  st_join(acs.2017) %>%
  select(-LINE,-TERMINUS, -ROUTE)%>%  
  mutate(across(where(is.numeric), ~ replace_na(., 0))) %>% 
  group_by(STATION)%>%
  summarize(across(all_of(columns_to_sum), sum, na.rm = TRUE), .groups = "drop")%>%
  mutate(ave.pop.den = round(ifelse(as.numeric(area) > 0, pop.tot / area, 0),digits = 2),
         ave.hh.den = round(ifelse(as.numeric(area) > 0, hh.tot / area, 0),digits = 2),
         commuter.tot = com.tot-com.home,
         ave.white.share = round(ifelse(pop.tot > 0, pop.white / pop.tot, 0) * 100, digits = 2),
         ave.car.share = round(ifelse(com.tot > 0, com.car / (com.tot-com.home), 0)*100, digits = 2),
         ave.bus.share = round(ifelse(com.tot > 0, com.bus / (com.tot-com.home), 0)*100, digits = 2),
         ave.sub.share = round(ifelse(com.tot > 0, com.sub / (com.tot-com.home), 0)*100, digits = 2),
         ave.rail.share = round(ifelse(com.tot > 0, com.rail / (com.tot-com.home), 0)*100, digits = 2),
         ave.tro.share = round(ifelse(com.tot > 0, com.trolley / (com.tot-com.home), 0)*100, digits = 2),
         ave.bike.share = round(ifelse(com.tot > 0, com.bike / (com.tot-com.home), 0)*100, digits = 2),
         ave.tran.share = round(ifelse(com.tot > 0, (com.sub+com.rail+com.trolley) / (com.tot-com.home), 0)*100, digits = 2),
         ave.veh.ownership = round(ifelse(hh.tot > 0, (hh.noveh.own+hh.noveh.rent) / hh.tot, 0)*100, digits = 2),
         ave.pover.rate = round(ifelse(hh.tot > 0, hh.pover / hh.tot, 0)*100, digits = 2),
         ave.labor.rate = round(ifelse(pop.16 > 0, pop.labor / pop.16, 0)*100, digits = 2),
         ave.employ.rate = round(ifelse(pop.civil > 0, pop.emp / pop.civil, 0)*100, digits = 2),
         ave.job.den = round(ifelse(as.numeric(area) > 0, job / area, 0),digits = 2))%>%
  rename(pop.all = pop.tot,
         commuter.all = commuter.tot,
         hh.all = hh.tot,
         job.all = job)%>%
  select(STATION,
         pop.all,ave.pop.den,commuter.all,
         hh.all,ave.hh.den,
         job.all,ave.job.den,
         ave.white.share,
         ave.car.share,ave.bus.share,ave.sub.share,ave.rail.share,ave.tro.share,ave.bike.share,ave.tran.share,
         ave.veh.ownership,
         ave.pover.rate,
         ave.labor.rate,ave.employ.rate)
  
acs.2017.stop <- acs.2017.stop.dot %>%
  st_drop_geometry()%>%
  select(-GEOID)%>%
  left_join(acs.2017.stop.buffer, by = 'STATION')

```


```{r acs-join-2019}
## 2019
# value
acs.2019.stop.dot <- tran_stop %>%
  st_join(acs.2019)%>%
  mutate(pop.den = round(ifelse(as.numeric(area) > 0, pop.tot / area, 0),digits = 2),
         hh.den = round(ifelse(as.numeric(area) > 0, hh.tot / area, 0),digits = 2),
         commuter.tot = com.tot-com.home,
         white.share = round(ifelse(pop.tot > 0, pop.white / pop.tot, 0) * 100, digits = 2),
         car.share = round(ifelse(com.tot > 0, com.car / (com.tot-com.home), 0)*100, digits = 2),
         bus.share = round(ifelse(com.tot > 0, com.bus / (com.tot-com.home), 0)*100, digits = 2),
         sub.share = round(ifelse(com.tot > 0, com.sub / (com.tot-com.home), 0)*100, digits = 2),
         rail.share = round(ifelse(com.tot > 0, com.rail / (com.tot-com.home), 0)*100, digits = 2),
         tro.share = round(ifelse(com.tot > 0, com.trolley / (com.tot-com.home), 0)*100, digits = 2),
         bike.share = round(ifelse(com.tot > 0, com.bike / (com.tot-com.home), 0)*100, digits = 2),
         tran.share = round(ifelse(com.tot > 0, (com.sub+com.rail+com.trolley) / (com.tot-com.home), 0)*100, digits = 2),
         veh.ownership = round(ifelse(hh.tot > 0, (hh.noveh.own+hh.noveh.rent) / hh.tot, 0)*100, digits = 2),
         pover.rate = round(ifelse(hh.tot > 0, hh.pover / hh.tot, 0)*100, digits = 2),
         labor.rate = round(ifelse(pop.16 > 0, pop.labor / pop.16, 0)*100, digits = 2),
         employ.rate = round(ifelse(pop.civil > 0, pop.emp / pop.civil, 0)*100, digits = 2),
         job.den = round(ifelse(as.numeric(area) > 0, job / area, 0),digits = 2))%>%
  select(STATION,GEOID,
         pop.tot,pop.den,commuter.tot,
         hh.tot,hh.den,
         job,job.den,
         white.share,
         car.share,bus.share,sub.share,rail.share,tro.share,bike.share,tran.share,
         veh.ownership,
         medInc, pover.rate,
         labor.rate,employ.rate)

# buffer- average value 
columns_to_sum <- setdiff(names(acs.2019), c("GEOID", "geometry"))
acs.2019.stop.buffer <- tran_stop %>%
  st_buffer(radius) %>%
  st_join(acs.2019) %>%
  select(-LINE,-TERMINUS, -ROUTE)%>%  
  mutate(across(where(is.numeric), ~ replace_na(., 0))) %>% 
  group_by(STATION)%>%
  summarize(across(all_of(columns_to_sum), sum, na.rm = TRUE), .groups = "drop")%>%
  mutate(ave.pop.den = round(ifelse(as.numeric(area) > 0, pop.tot / area, 0),digits = 2),
         ave.hh.den = round(ifelse(as.numeric(area) > 0, hh.tot / area, 0),digits = 2),
         commuter.tot = com.tot-com.home,
         ave.white.share = round(ifelse(pop.tot > 0, pop.white / pop.tot, 0) * 100, digits = 2),
         ave.car.share = round(ifelse(com.tot > 0, com.car / (com.tot-com.home), 0)*100, digits = 2),
         ave.bus.share = round(ifelse(com.tot > 0, com.bus / (com.tot-com.home), 0)*100, digits = 2),
         ave.sub.share = round(ifelse(com.tot > 0, com.sub / (com.tot-com.home), 0)*100, digits = 2),
         ave.rail.share = round(ifelse(com.tot > 0, com.rail / (com.tot-com.home), 0)*100, digits = 2),
         ave.tro.share = round(ifelse(com.tot > 0, com.trolley / (com.tot-com.home), 0)*100, digits = 2),
         ave.bike.share = round(ifelse(com.tot > 0, com.bike / (com.tot-com.home), 0)*100, digits = 2),
         ave.tran.share = round(ifelse(com.tot > 0, (com.sub+com.rail+com.trolley) / (com.tot-com.home), 0)*100, digits = 2),
         ave.veh.ownership = round(ifelse(hh.tot > 0, (hh.noveh.own+hh.noveh.rent) / hh.tot, 0)*100, digits = 2),
         ave.pover.rate = round(ifelse(hh.tot > 0, hh.pover / hh.tot, 0)*100, digits = 2),
         ave.labor.rate = round(ifelse(pop.16 > 0, pop.labor / pop.16, 0)*100, digits = 2),
         ave.employ.rate = round(ifelse(pop.civil > 0, pop.emp / pop.civil, 0)*100, digits = 2),
         ave.job.den = round(ifelse(as.numeric(area) > 0, job / area, 0),digits = 2))%>%
  rename(pop.all = pop.tot,
         commuter.all = commuter.tot,
         hh.all = hh.tot,
         job.all = job)%>%
  select(STATION,
         pop.all,ave.pop.den,commuter.all,
         hh.all,ave.hh.den,
         job.all,ave.job.den,
         ave.white.share,
         ave.car.share,ave.bus.share,ave.sub.share,ave.rail.share,ave.tro.share,ave.bike.share,ave.tran.share,
         ave.veh.ownership,
         ave.pover.rate,
         ave.labor.rate,ave.employ.rate)
  
acs.2019.stop <- acs.2019.stop.dot %>%
  st_drop_geometry()%>%
  select(-GEOID)%>%
  left_join(acs.2019.stop.buffer, by = 'STATION')
```

# Data Visualization

## Transit Data

```{r tran_map}

```

## Bike Data

```{r bike_map}
# The map of  in 2017
breaks_quantiles <- classIntervals(tran_rider_17_total$, n = 5, style = "quantile")
colors <- brewer.pal(n = 5, name = "Blues")
labels <- paste0(formatC(breaks_quantiles$brks[-length(breaks_quantiles$brks)], format = "f", digits = 0, big.mark = ","), 
                 " - ", 
                 formatC(breaks_quantiles$brks[-1], format = "f", digits = 0, big.mark = ","))

ggplot(tran_rider_17_total) +
  geom_sf(aes(fill = cut(, breaks = breaks_quantiles$brks, include.lowest = TRUE)), color = "transparent") +
  scale_fill_manual(values = colors,
                    labels = labels,
                    name = " (Quantile)") +
  labs(title = ", 2017") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = c(1, 0.2))+
  geom_sf(data = , fill = NA, color = "grey", inherit.aes = FALSE) +
  geom_text(data = , aes(x = lon, y = lat, label = district), size = 1.75,
            color = "black",check_overlap = TRUE, inherit.aes = FALSE)
```

## Sociodemographic Data

```{r demographic_map}

```


# Model Building

## Final Dataset

```{r final_data}
## 2017 without Time Period
final_17_total <- tran_rider_17_total %>%
  st_buffer(radius) %>%
  st_join(bike_rider_17_total) %>%
  group_by(tran_stop) %>%
  summarise(total_rider_bike = sum(total_rider_bike)) %>%
  ungroup() %>%
  mutate(total_rider_bike = replace_na(total_rider_bike, 0)) %>%
  left_join(.,tran_rider_17_total %>%
              st_drop_geometry() %>%
              select(tran_stop, total_rider_tran), by = c("tran_stop")) %>%
  na.omit()

## 2019 without Time Period
final_19_total <- tran_rider_19_total %>%
  st_buffer(radius) %>%
  st_join(bike_rider_19_total) %>%
  group_by(tran_stop) %>%
  summarise(total_rider_bike = sum(total_rider_bike)) %>%
  ungroup() %>%
  mutate(total_rider_bike = replace_na(total_rider_bike, 0)) %>%
  left_join(.,tran_rider_19_total %>%
              st_drop_geometry() %>%
              select(tran_stop, total_rider_tran), by = c("tran_stop")) %>%
  na.omit()

## 2017 with Time Period


## 2019 with Time Period


```

## Simple Regression

```{r step1}
## 2017
mod1 <- lm(total_rider_tran ~ total_rider_bike, data = final_17_total)
summary(mod1)

## 2019
mod2 <- lm(total_rider_tran ~ total_rider_bike, data = final_19_total)
summary(mod2)
```

## Multiple Regression without Time Period

```{r step2}
## 2017


## 2019


```

## Multiple Regression with Time Period

```{r step3}
## 2017


## 2019


```

## Multiple Regression with Time Period (Interaction Term)

```{r step4}
## 2017


## 2019


```


# Next Step

