---
title: "Assignment#3_Logistic Regression"
author: "Viva"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: flatly
    toc_float: yes
    code_folding: hide
    number_sections: no
    fontsize: 12pt
  pdf_document:
    toc: yes
---

<style>
.kable thead tr th, .table thead tr th {
  text-align: left !important;}
table.kable, table.table {
  width: 100% !important;}
  body {
  line-height: 1.6;
  font-size: 16px
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dpi = 150)
options(scipen = 999)

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, sf, units, nngeo, tmap, tinytex, kableExtra, janitor, classInt,
       patchwork, here, tidycensus, lwgeom, lsr, haven, descr, RColorBrewer, stargazer,
       car, FNN, GGally, MASS, ISLR2, spdep, caret, ckanr, grid, gridExtra, ggcorrplot,
       jtools, broom, tufte, rmarkdown, corrr, RSocrata, viridis, spatstat, raster, knitr,
       classInt)

library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)
```

# Question 1
## Choose variable


```{r variable}
# Viva's path
all <- read_csv('/Users/Viva Wan/Documents/GitHub/Local/cpln505_assignment3_voting_data.csv')
# Yaohan's path
all <- read_csv('/Users/Viva Wan/Documents/GitHub/Local/cpln505_assignment3_voting_data.csv')

dat <- all %>%
  select(VCF0004,VCF0704a,
         VCF0101,VCF0103,VCF0104,VCF0105a,VCF0128,VCF0114,VCF0140a,VCF0148a,VCF0108,
         VCF0878,VCF9239,VCF0656,
         VCF0302,VCF0113) %>%
  filter(VCF0004 == 2012 | VCF0004 == 2016) %>%
  rename(# target variables
         year = VCF0004,
         candidate = VCF0704a, 
         # demographics
         age = VCF0101,
         birth = VCF0103,
         gender = VCF0104,
         race = VCF0105a,
         religion = VCF0128,
         income = VCF0114,
         education = VCF0140a,
         class = VCF0148a,
         hispanic = VCF0108,
         # political ideology
         lgbt = VCF0878,
         gun = VCF9239,
         trust = VCF0656,
         # Political Affiliation
         party = VCF0302,
         south = VCF0113)%>%
  filter(candidate != 0,
         !(gender %in% c(0,3)), 
           race != 9,
           birth !=0,
           religion !=0,
           income != 0,
           education!=9, 
           class != 9, 
           !(hispanic %in% c(8,9)),
           !(lgbt %in% c(9)), 
           !(gun %in% c(-8,-9)),
           trust != 999,
           !(party %in% c(8,9))) %>%
  na.omit() %>%
  mutate(candidate = as.factor(recode(candidate,
                                     `1` = 'democrat',
                                     `2` = 'republican')),
         gender = as.factor(recode(gender,
                                       `1` = 'male',
                                       `2` = 'female')),
         birth = as.factor(recode(birth,
                                  `1`='after1991',
                                  `2`='1975-1990',
                                  `3`='1959-1974',
                                  `4`='1943-1958',
                                  `5`='1927-1942',
                                  `6`='1911-1926',
                                  `7`='1895-1910',
                                  `8`='Before1895')),
         race = as.factor(recode(race,
                                 `1`='White non-Hispanic',
                                 `2`='Black non-Hispanic',
                                 `3`='Asian or Pacific Islander, non-Hispanic',
                                 `4`='American Indian or Alaska native non-Hispanic',
                                 `5`='Hispanic',
                                 `6`='Other or multiple races, non-Hispanic')),
         religion = as.factor(recode(religion,
                                     `1`='Protestant',
                                     `2`='Roman Catholic',
                                     `3`='Jewish',
                                     `4`='Other')),
         income = as.factor(recode(income,
                                   `1`='0-16th',
                                   `2`='17-33rd',
                                   `3`='34-67th',
                                   `4`='68-95th',
                                   `5`='96-100th')),
         education = as.factor(recode(income,
                                   `1`='8th-grade',
                                   `2`='9-12th-grade',
                                   `3`='high-school',
                                   `4`='training',
                                   `5`='no-degree',
                                   `6`='bachelor',
                                   `7`='advanced')),
         class = as.factor(recode(class,
                                  `1`='1ave-working',
                                  `2`='2working',
                                  `3`='3upper-working',
                                  `4`='4ave-middle',
                                  `5`='5middle',
                                  `6`='6upper-middle')),
         hispanic = as.factor(recode(gender,
                                       `1` = 'hispanic',
                                       `2` = 'non-hispanic')),
         lgbt = as.factor(recode(gender,
                                 `1` = 'yes',
                                 `2` = 'no',
                                 `3` = 'dk')),
         gun = as.factor(recode(gun,
                                `1` = 'extreme',
                                `2` = 'very',
                                `3` = 'somewhat',
                                `4`='not-too',
                                `5`='not-at-all')),
         trust = factor(case_when(
           trust == 0 ~ "no",
           trust <= 25 & trust >0 ~ "not-too",
           trust <= 50 & trust > 25 ~ "some",
           trust <= 75 & trust > 50 ~ "very",
           trust >75 ~ "extreme")),
         party = as.factor(recode(party,
                                `5`='democrat',
                                `1` = 'republican',
                                `2` = 'Independent',
                                `3` = 'none',
                                `4`='other')),
         south = as.factor(recode(south,
                                 `1` = 'south',
                                 `2` = 'non-south')))

dat.12 <- subset(dat[dat$year == 2012,]) 
dat.16 <- subset(dat[dat$year == 2016,])
```

```{r reclassify 2012}
reclassify.var <- c('birth','race','income','education','class')
plot.12 <- list()

for (i in 1:length(reclassify.var)) {
  var = reclassify.var[i]
  
  plot.12[[i]] <- dat.12 %>%
    select(candidate, !!sym(var)) %>% na.omit() %>%
    group_by(candidate,!!sym(var)) %>%
    summarize(count.vote = n(), .groups = 'drop') %>%
    group_by(!!sym(var))%>%
    mutate(percentage = round(count.vote/sum(count.vote)*100), digit= 0)%>%
    ungroup()%>%
      ggplot(aes(!!sym(var),percentage)) +
        geom_bar(aes(fill= candidate), position="dodge", stat="identity") +
        scale_fill_viridis(discrete = TRUE) +
        labs(title = paste("Percentage of Voting by", var, "in 2012")) +
        theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(plot.12[[i]])
}

```


