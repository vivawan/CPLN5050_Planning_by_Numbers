---
title: "Final Assignment"
author: "Viva/Yaohan"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: flatly
    toc_float: yes
    code_folding: hide
    number_sections: no
  pdf_document:
    toc: yes
---

<style>
.kable thead tr th, .table thead tr th {
  text-align: left !important;}
table.kable, table.table {
  width: 100% !important;}
  body {
  line-height: 1.6;
  font-size: 16px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dpi = 150)
options(scipen = 999)

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, sf, units, nngeo, tmap, tinytex, kableExtra, janitor, classInt,lehdr,
       patchwork, here, tidycensus, lwgeom, lsr, haven, descr, RColorBrewer, stargazer,
       car, FNN, GGally, MASS, ISLR2, spdep, caret, ckanr, grid, gridExtra, ggcorrplot,
       jtools, broom, tufte, rmarkdown, corrr, RSocrata, viridis, spatstat, raster, knitr,
       arm, mlogit, readxl, lubridate)

library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)
conflicts_prefer(sf::st_crs)
conflicts_prefer(corrr::correlate)

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```


# Data Preparation

1. Transit Data
- Transit Ridership
MBTA Rail Ridership by Time Period, Season, Route/Line, and Stop: https://mbta-massdot.opendata.arcgis.com/search?tags=ridership
The data is for Fall2019, Fall2018, and Fall2017. We choose the latest one, Fall2019.

- Transit Station
MBTA Rapid Transit: https://www.mass.gov/info-details/massgis-data-mbta-rapid-transit#downloads-
Name and location for each transit stopï¼› Combined with ridership data.

- Service Delivery Policy
Definition for "Fall" in MassDOT: https://www.mass.gov/doc/controls-guidelines-attachment-a-important-work-restrictions/download
The Fall season defined by MassDOT is from August.15 to November.1, so we use bike data for August, September and October.
Definition for "Time Period" in MassDOT: https://cdn.mbta.com/sites/default/files/2021-09/service-delivery-policy-june-2021.pdf

2. Bike Data
- Bike Ridership
Blue Bikes Comprehensive Trip Histories: https://s3.amazonaws.com/hubway-data/index.html
2019: August, September, October

- Bike Station
Bluebikes Stations: https://bluebikes.com/system-data

3. Bus Data
MBTA Bus Routes and Stops: https://www.mass.gov/info-details/massgis-data-mbta-bus-routes-and-stops?_gl=1*1iy371g*_ga*MTQzMTUzMDg3Mi4xNzA4MTExODY2*_ga_MCLPEGW7WM*MTcxMzg4OTY1OC4xLjEuMTcxMzg4OTY4MS4wLjAuMA..#overview-

4. MBTA Boundary
MBTA Core Service Area: https://mbta-massdot.opendata.arcgis.com/search?q=boundary

5. LEHD and ACS Data
https://lehd.ces.census.gov/data/
https://data.census.gov/

7. CRS
NAD83 / Massachusetts Mainland (ftUS)
https://epsg.io/2249

## Import Datasets

```{r load_data, message = FALSE, warning = FALSE}
# Transit Data
## Transit Ridership
tran_rider <- read_csv(here::here("data/final/Transit_Ridership.csv"))
## Transit Station
tran_line <- st_read(here::here("data/final/mbta_rapid_transit/MBTA_ARC.shp")) %>%
  st_transform(crs = 2249)
tran_stop <- st_read(here::here("data/final/mbta_rapid_transit/MBTA_NODE.shp")) %>%
  st_transform(crs = 2249)


# Bike Data
## Bike Ridership
bike_rider_19_aug <- read_csv(here::here("data/final/201908-bluebikes-tripdata.csv"))
bike_rider_19_sep <- read_csv(here::here("data/final/201909-bluebikes-tripdata.csv"))
bike_rider_19_oct <- read_csv(here::here("data/final/201910-bluebikes-tripdata.csv"))
## Bike Station
bike_stop <- read_csv(here::here("data/final/current_bluebikes_stations.csv"))


# Bus Stop
bus_stop <- st_read(here::here("data/final/mbtabus/MBTABUSSTOPS_PT.shp")) %>%
  st_transform(crs = 2249)


# MBTA Boundary
mbta_core <- st_read(here::here("data/final/Core_Service_Area/Core_Service_Area.shp")) %>%
  st_transform(crs = 2249)


# Set Search Radius
radius <- c(1320)
```


# Data Wrangling

## MBTA Boundary

```{r boundary}
mbta_core <- mbta_core %>%
  st_union() %>%
  st_as_sf()
```

## Transit Data

```{r transit}
## Align Station Name between Two Datasets
tran_rider <- tran_rider %>%
  mutate(stop_name = case_when(
    stop_name == "Back of the Hill" ~ "Back Of The Hill",
    stop_name == "Boston Univ. Central" ~ "Boston University Central",
    stop_name == "Boston Univ. East" ~ "Boston University East",
    stop_name == "Boston Univ. West" ~ "Boston University West",
    stop_name == "Chestnut Hill Ave." ~ "Chestnut Hill Avenue",
    stop_name == "Englewood Ave." ~ "Englewood Avenue",
    stop_name == "Harvard Ave." ~ "Harvard Avenue",
    stop_name == "JFK/Umass" ~ "JFK/UMass",
    stop_name == "Massachusetts Ave." ~ "Massachusetts Ave",
    stop_name == "Museum of Fine Arts" ~ "Museum Of Fine Arts",
    stop_name == "Northeastern University" ~ "Northeastern",
    stop_name == "Saint Mary Street" ~ "Saint Marys Street",
    stop_name == "Science Park" ~ "Science Park/West End",
    stop_name == "State Street" ~ "State",
    stop_name == "Summit Ave." ~ "Summit Avenue",
    TRUE ~ stop_name))

name_rider <- unique(tran_rider$stop_name) # 113
name_stop <- tran_stop$STATION # 170
not_in_station <- as.data.frame(setdiff(name_rider, name_stop)) # station in ridership but not in stop shapefile -> final 111 stations

tran_stop <- tran_stop %>%
  filter(LINE != "SILVER") ## Silver Line is BRT

## Transit Ridership
tran_rider <- tran_rider %>%
  mutate(time_period = paste(day_type_name, time_period_name, sep = "_"))

### Transit Ridership by Time Period
tran_rider_19_period <- tran_rider %>%
  filter(season == "Fall 2019") %>%
  group_by(stop_name, time_period) %>%
  summarise(aver_ons = sum(average_ons),
            aver_offs = sum(average_offs)) %>%
  ungroup() %>%
  mutate(total_rider_tran = aver_ons + aver_offs) %>%
  left_join(., tran_stop, by = c("stop_name" = "STATION")) %>%
  na.omit() %>%
  select(-aver_ons, -aver_offs, -LINE, -ROUTE) %>%
  rename(tran_stop = stop_name, terminus = TERMINUS) %>%
  st_as_sf()

### Total Transit Ridership
tran_rider_19_total <- tran_rider_19_period %>%
  st_drop_geometry() %>%
  group_by(tran_stop) %>%
  summarise(total_rider_tran = sum(total_rider_tran)) %>%
  ungroup() %>%
  left_join(., tran_stop, by = c("tran_stop" = "STATION")) %>%
  na.omit() %>%
  select(-LINE, -ROUTE) %>%
  rename(terminus = TERMINUS) %>%
  st_as_sf()
```

## 2019 Bike Data

```{r bike_2019}
## Bike Station
colnames(bike_stop) <- as.character(unlist(bike_stop[1, ]))
bike_stop <- bike_stop[-1, ] %>%
  select(name = NAME,
         total_docks = `Total Docks`) %>%
  rename(bike_stop = name)

## Combine 2019
bike_rider_19 <- bind_rows(bike_rider_19_aug, bike_rider_19_sep, bike_rider_19_oct)
sum(duplicated(bike_rider_19))

### Start Trips
bike_rider_19_start <- bike_rider_19 %>%
  separate(col = starttime, into = c("date", "time"), sep = " ") %>%
  mutate(day_type_name = case_when(
      wday(date, label = TRUE, week_start = 1) %in% c("Sat") ~ "saturday",
      wday(date, label = TRUE, week_start = 1) %in% c("Sun") ~ "sunday",
      TRUE ~ "weekday")) %>%
  mutate(time_period_name = case_when(
      time >= "03:00:00" & time < "06:00:00" ~ "VERY_EARLY_MORNING",
      time >= "06:00:00" & time < "07:00:00" ~ "EARLY_AM",
      time >= "07:00:00" & time < "09:00:00" ~ "AM_PEAK",
      time >= "09:00:00" & time < "13:30:00" ~ "MIDDAY_BASE",
      time >= "13:30:00" & time < "16:00:00" ~ "MIDDAY_SCHOOL",
      time >= "16:00:00" & time < "18:30:00" ~ "PM_PEAK",
      time >= "18:30:00" & time < "22:00:00" ~ "EVENING",
      time >= "22:00:00" & time < "24:00:00" ~ "LATE_EVENING",
      time >= "00:00:00" & time < "03:00:00" ~ "NIGHT",
      TRUE ~ NA)) %>%
  mutate(time_period_change = case_when(
  day_type_name %in% c("saturday", "sunday") ~ "OFF_PEAK",
  TRUE ~ time_period_name)) %>%
  mutate(time_period = paste(day_type_name, time_period_change, sep = "_")) %>%
  group_by(time_period, `start station name`) %>%
  summarise(Start_Trip_19 = n()) %>%
  ungroup() %>%
  rename(bike_stop = `start station name`)

### End Trips
bike_rider_19_end <- bike_rider_19 %>%
  separate(col = stoptime, into = c("date", "time"), sep = " ") %>%
  mutate(day_type_name = case_when(
      wday(date, label = TRUE, week_start = 1) %in% c("Sat") ~ "saturday",
      wday(date, label = TRUE, week_start = 1) %in% c("Sun") ~ "sunday",
      TRUE ~ "weekday")) %>%
  mutate(time_period_name = case_when(
      time >= "03:00:00" & time < "06:00:00" ~ "VERY_EARLY_MORNING",
      time >= "06:00:00" & time < "07:00:00" ~ "EARLY_AM",
      time >= "07:00:00" & time < "09:00:00" ~ "AM_PEAK",
      time >= "09:00:00" & time < "13:30:00" ~ "MIDDAY_BASE",
      time >= "13:30:00" & time < "16:00:00" ~ "MIDDAY_SCHOOL",
      time >= "16:00:00" & time < "18:30:00" ~ "PM_PEAK",
      time >= "18:30:00" & time < "22:00:00" ~ "EVENING",
      time >= "22:00:00" & time < "24:00:00" ~ "LATE_EVENING",
      time >= "00:00:00" & time < "03:00:00" ~ "NIGHT",
      TRUE ~ NA)) %>%
  mutate(time_period_change = case_when(
  day_type_name %in% c("saturday", "sunday") ~ "OFF_PEAK",
  TRUE ~ time_period_name)) %>%
  mutate(time_period = paste(day_type_name, time_period_change, sep = "_")) %>%
  group_by(time_period, `end station name`) %>%
  summarise(End_Trip_19 = n()) %>%
  ungroup() %>%
  rename(bike_stop = `end station name`)

### 2019 Bike Stops
bike_stop_19 <- bike_rider_19 %>%
  select(Name = `end station name`,
         Long = `end station longitude`,
         Lat = `end station latitude`) %>%
  group_by(Name, Long, Lat) %>%
  tally() %>%
  ungroup() %>%
  select(-n) %>%
  distinct(Name, .keep_all = TRUE) %>%
  filter(Lat != 0 & Long != 0) %>%
  rename(bike_stop = Name)

### 2019 Total Trips
bike_rider_19_period <- bike_rider_19_start %>%
  left_join(., bike_rider_19_end, by = c("bike_stop", "time_period")) %>%
  mutate(total_rider_bike = Start_Trip_19 + End_Trip_19) %>%
  left_join(bike_stop_19, ., by = "bike_stop") %>%
  na.omit() %>%
  st_as_sf(coords = c("Long", "Lat"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(bike_stop, time_period, total_rider_bike) %>%
  left_join(., bike_stop, by = "bike_stop") %>%
  mutate(total_docks = as.numeric(total_docks)) %>%
  mutate(total_docks = replace_na(total_docks,
                                  floor(mean(total_docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(total_docks, .before = geometry)

bike_rider_19_total <- bike_rider_19_period %>%
  group_by(bike_stop) %>%
  summarise(total_rider_bike = sum(total_rider_bike)) %>%
  ungroup() %>%
  left_join(., bike_stop, by = "bike_stop") %>%
  mutate(total_docks = as.numeric(total_docks)) %>%
  mutate(total_docks = replace_na(total_docks,
                                  floor(mean(total_docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(total_docks, .before = geometry)
```

## Bus Data

```{r bus}
## Bus Stop
bus_stop <- bus_stop %>%
  select(STOP_NAME) %>%
  rename(bus_stop = STOP_NAME) %>%
  distinct(bus_stop, .keep_all = TRUE)
```

## LEHD and ACS data

**Built Environment Variables**
- Total population 
- Population density 
- Total commuting workers
- Total occupied house unit 
- Housing density 
- Total employment
- Employment density

**Socioeconomic Variables**
- Non-white share
- Commute in vehicles share
- Commute in bus share
- Commute by subway share
- Commute by rail share
- Commute by trolley share
- Commute by bike share
- Vehicle ownership for household
- Household median income
- Poverty rate
- Labor force participation rate
- Employment rate

```{r LEHD}
# LEHD data - 2019
job.2019<- grab_lodes(state = "ma", year = 2019, 
                    lodes_type = "wac", # wac, Workplace Area Characteristic data, jobs are totaled by work Census Block
                    job_type = "JT01", #primary jobs
                    segment = "S000", #total jobs
                    state_part = "main", #both worklace and residence in-state
                    agg_geo = "bg",
                    download_dir = file.path("data/raw"))%>%
  select(w_bg,C000)%>%
  rename(job = C000)
```

### Variable List

```{r acs.var}
census_api_key("3ec2bee8c227ff3f9df970d0ffbb11ee1384076e", install = TRUE, overwrite = TRUE)
readRenviron("~/.Renviron")

# get variables
acs_variable_list.2019 <- load_variables(2019, "acs5")%>%
  filter(geography == 'block group')

acs.var <- c('B01001_001E',#total population
             #-> non-white share
             'B03002_003E',#White Non-Hispanic
             #-> commute mode share
             'B08301_001E',#Workers 16 years and over
             'B08301_002E',#Car, truck, or van
             'B08301_012E',#Subway or elevated rail
             'B08301_013E',#Long-distance train or commuter rail
             'B08301_014E',#Streetcar or trolley car
             'B08301_018E',#cyclists
             'B08301_021E',#working form home
             #-> vehicle ownership for household
             'B25044_001E',#Occupied housing units
             'B25044_003E',#No vehicle available for owned units
             'B25044_010E',#No vehicle available for rented units
             #-> household median income
             'B19013_001E',#median income for household
             #-> poverty rate
             'B17017_002E',#Income in the past 12 months below poverty level
             #-> employment rate
             'B23025_003E',#Civilian labor force
             'B23025_004E')#population employed
```

### Download Data

```{r acs data}
#get data
acs.2019 <- get_acs(geography = "block group",
                    year = 2019,
                    variables = acs.var,
                    geometry = TRUE,
                    survey = "acs5",
                    state = "MA",
                    output = "wide")%>%
  st_transform(crs = 2249) %>%
  select(GEOID, all_of(acs.var)) %>%
  rename(pop.tot = B01001_001E,
         pop.white = B03002_003E, 
         com.tot = B08301_001E, 
         com.car = B08301_002E, 
         com.sub = B08301_012E, 
         com.rail = B08301_013E, 
         com.trolley = B08301_014E, 
         com.bike = B08301_018E,
         com.home = B08301_021E,
         hh.tot = B25044_001E,
         hh.noveh.own = B25044_003E,
         hh.noveh.rent = B25044_010E,
         medInc = B19013_001E,
         hh.pover = B17017_002E,
         pop.civil = B23025_003E,
         pop.emp = B23025_004E)%>%
  mutate(area = st_area(.)) %>%
  mutate(area = set_units(x = area, value = "acres"))%>%
  left_join(job.2019, by = c('GEOID'='w_bg')) #join job data
```

### Join to Station

```{r acs-join}
## calculate value
acs.2019.stop <- tran_stop %>%
  st_join(acs.2019)%>%
  mutate(pop.den = round(ifelse(as.numeric(area) > 0, pop.tot / area, 0),digits = 2),
         hh.den = round(ifelse(as.numeric(area) > 0, hh.tot / area, 0),digits = 2),
         commuter.tot = com.tot-com.home,
         white.share = round(ifelse(pop.tot > 0, pop.white / pop.tot, 0) * 100, digits = 2),
         car.share = round(ifelse(com.tot > 0, com.car / (com.tot-com.home), 0)*100, digits = 2),
         bike.share = round(ifelse(com.tot > 0, com.bike / (com.tot-com.home), 0)*100, digits = 2),
         tran.share = round(ifelse(com.tot > 0, (com.sub+com.rail+com.trolley) / (com.tot-com.home), 0)*100, digits = 2),
         veh.ownership = round(ifelse(hh.tot > 0, (hh.noveh.own+hh.noveh.rent) / hh.tot, 0)*100, digits = 2),
         pover.rate = round(ifelse(hh.tot > 0, hh.pover / hh.tot, 0)*100, digits = 2),
         employ.rate = round(ifelse(pop.civil > 0, pop.emp / pop.civil, 0)*100, digits = 2),
         job.den = round(ifelse(as.numeric(area) > 0, job / area, 0),digits = 2))%>%
  select(STATION,
         pop.tot,pop.den,commuter.tot,
         hh.tot,hh.den,
         job,job.den,
         white.share,
         car.share,bike.share,tran.share,
         veh.ownership,
         medInc, pover.rate,employ.rate)%>%
  rename(tran_stop = STATION) %>%
  st_drop_geometry()%>%
  mutate(across(everything(), ~ replace_na(., 0)))
```

## Final Dataset

```{r final_data}
rm(list = setdiff(ls(), c("tran_rider_19_period", "tran_rider_19_total",
                          "bike_rider_19_period", "bike_rider_19_total",
                          "bus_stop", "mbta_core", "radius", "acs.2019.stop",
                          "nn_function")))

## 2019 without Time Period
final_19_total_bike <- tran_rider_19_total %>%
  st_buffer(radius) %>%
  st_join(bike_rider_19_total) %>%
  mutate(total_rider_bike = replace_na(total_rider_bike, 0)) %>%
  mutate(total_docks = replace_na(total_docks, 0)) %>%
  group_by(tran_stop) %>%
  summarise(total_rider_bike = sum(total_rider_bike),
            total_docks = sum(total_docks)) %>%
  ungroup() %>%
  st_drop_geometry()
  
final_19_total_bus <- tran_rider_19_total %>%
  st_buffer(radius) %>%
  st_join(bus_stop) %>%
  na.omit() %>%
  group_by(tran_stop) %>%
  tally() %>%
  ungroup() %>%
  st_drop_geometry()
  
final_19_total_acs <- final_19_total_bike %>%
  left_join(., final_19_total_bus, by = c("tran_stop")) %>%
  rename(bus_stop = n) %>%
  mutate(bus_stop = replace_na(bus_stop, 0)) %>%
  left_join(.,tran_rider_19_total %>%
              select(tran_stop, total_rider_tran, terminus), by = c("tran_stop")) %>%
  left_join(., acs.2019.stop, by = c("tran_stop")) %>%
  na.omit() %>%
  st_as_sf()%>%
  # aggregate ridership = 1weekday+2weekends -> ridership per day
  mutate(total_rider_bike = round(total_rider_bike/92, digits = 0),
         total_rider_tran = round(total_rider_tran/3, digits = 0))

### add distance factor
final_19_total_acs <- final_19_total_acs %>%
  mutate(nearest_bike =
        nn_function(st_coordinates(tran_rider_19_total), st_coordinates(bike_rider_19_total),1)) %>%
  st_drop_geometry()

## 2019 with Time Period
final_19_period_bike <- tran_rider_19_total %>%
  st_buffer(radius) %>%
  st_join(bike_rider_19_period) %>%
  mutate(total_rider_bike = replace_na(total_rider_bike, 0)) %>%
  group_by(tran_stop, time_period) %>%
  summarise(total_rider_bike = sum(total_rider_bike)) %>%
  ungroup() %>%
  st_drop_geometry()
  
final_19_period_bus <- tran_rider_19_total %>%
  st_buffer(radius) %>%
  st_join(bus_stop) %>%
  na.omit() %>%
  group_by(tran_stop) %>%
  tally() %>%
  ungroup() %>%
  st_drop_geometry()

final_19_period_acs <- final_19_period_bike %>%
  left_join(tran_rider_19_period %>%
              select(tran_stop, total_rider_tran, time_period, terminus), ., by = c("tran_stop", "time_period")) %>%
  mutate(total_rider_bike = replace_na(total_rider_bike, 0)) %>%
  left_join(., final_19_period_bus, by = c("tran_stop")) %>%
  rename(bus_stop = n) %>%
  mutate(bus_stop = replace_na(bus_stop, 0)) %>%
  left_join(., acs.2019.stop, by = c("tran_stop")) %>%
  na.omit() %>%
  st_drop_geometry() %>%
  # get the average ridership per day
  mutate(total_rider_bike = case_when(
    str_starts(time_period, "weekday") ~ total_rider_bike / 66,
    str_starts(time_period, "saturday") ~ total_rider_bike / 13,
    str_starts(time_period, "sunday") ~ total_rider_bike / 13)) %>%
  # get the ridership per hour for each period
  mutate(time_hour = case_when(
    time_period == 'weekday_VERY_EARLY_MORNING'~ 3,
    time_period == 'weekday_EARLY_AM'~ 1,
    time_period == 'weekday_AM_PEAK'~ 2,
    time_period == 'weekday_MIDDAY_BASE'~ 4.5,
    time_period == 'weekday_MIDDAY_SCHOOL'~ 2.5,
    time_period == 'weekday_PM_PEAK'~ 2.5,
    time_period == 'weekday_EVENING'~ 3.5,
    time_period == 'weekday_LATE_EVENING'~ 2,
    time_period == 'weekday_NIGHT'~ 3,
    time_period == 'saturday_OFF_PEAK'~ 18,
    time_period == 'sunday_OFF_PEAK'~ 17
    ))%>%
  mutate(hour_rider_tran = round(total_rider_tran/time_hour, digits = 0),
         hour_rider_bike = round(total_rider_bike/time_hour, digits = 0)) %>%
  select(-total_rider_bike, -total_rider_tran)%>%
  mutate(time_period_cat = case_when(
    time_period %in% c("saturday_OFF_PEAK", "sunday_OFF_PEAK") ~ "weekend",
    time_period %in% c("weekday_AM_PEAK", "weekday_PM_PEAK") ~ "weekday_peak",
    TRUE ~ "weekday_off_peak"))
```


# Data Visualization

## Ridership by Time Period

```{r ridership per hour by time period, fig.height=5.5, fig.width=7}
# Before
tran_rider_19_period %>% 
  mutate(time_period = factor(time_period,
                              levels = c(
    'weekday_VERY_EARLY_MORNING',
    'weekday_EARLY_AM',
    'weekday_AM_PEAK',
    'weekday_MIDDAY_BASE',
    'weekday_MIDDAY_SCHOOL',
    'weekday_PM_PEAK',
    'weekday_EVENING',
    'weekday_LATE_EVENING',
    'weekday_NIGHT',
    'saturday_OFF_PEAK',
    'sunday_OFF_PEAK'
  )))%>%
  group_by(time_period)%>%
  summarize(mean.tran.ridership = mean(total_rider_tran))%>%
  ggplot(., aes(x = time_period, y = mean.tran.ridership))+
  geom_col(color = "black", fill = "grey", width = 0.65) +
  labs(x = "", y = "") +
  geom_hline(yintercept = 0, size = 0.6, color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(size = 8))

# After
final_19_period_acs %>% 
  mutate(time_period = factor(time_period,
                              levels = c(
    'weekday_VERY_EARLY_MORNING',
    'weekday_EARLY_AM',
    'weekday_AM_PEAK',
    'weekday_MIDDAY_BASE',
    'weekday_MIDDAY_SCHOOL',
    'weekday_PM_PEAK',
    'weekday_EVENING',
    'weekday_LATE_EVENING',
    'weekday_NIGHT',
    'saturday_OFF_PEAK',
    'sunday_OFF_PEAK'
  )))%>%
  group_by(time_period)%>%
  summarize(mean.hour.ridership = mean(hour_rider_tran)) %>%
  ggplot(., aes(x = time_period, y = mean.hour.ridership)) +
  geom_col(color = "black", fill = "grey", width = 0.65) +
  labs(x = "", y = "") +
  geom_hline(yintercept = 0, size = 0.6, color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(size = 8))
```

## Log Transformation of Ridership Data

```{r log_ridership, fig.height=5.5, fig.width=7}
# Transit Ridership
ggplot(final_19_total_acs, aes(x = total_rider_tran)) +
  geom_histogram(color = "black", fill = "grey", bins = 15) +
  labs(x = "", y = "") +
  geom_hline(yintercept = 0, size = 0.6, color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8))

ggplot(final_19_total_acs, aes(x = log(total_rider_tran))) +
  geom_histogram(color = "black", fill = "grey", bins = 15) +
  labs(x = "", y = "") +
  geom_hline(yintercept = 0, size = 0.6, color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8))

# Bike Ridership
ggplot(final_19_total_acs, aes(x = total_rider_bike)) +
  geom_histogram(color = "black", fill = "grey", bins = 15) +
  labs(x = "", y = "") +
  geom_hline(yintercept = 0, size = 0.6, color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8))

ggplot(final_19_total_acs, aes(x = log(total_rider_bike + 1))) +
  geom_histogram(color = "black", fill = "grey", bins = 15) +
  labs(x = "", y = "") +
  geom_hline(yintercept = 0, size = 0.6, color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8))
```


# Model Building

## Simple Regression

```{r step1}
rm(list = setdiff(ls(), c("final_19_total_acs", "final_19_period_acs")))

mod.0 <- lm(log(total_rider_tran) ~ log(total_rider_bike + 1), data = final_19_total_acs)
summary(mod.0)
```

## Multiple Regression without Time Period

```{r cor_test, warning=FALSE, message=FALSE}
# Correlation Plot
## Select only numeric variables and remove rows with missing values
numericVars <- final_19_total_acs %>%
  st_drop_geometry()%>%
  select_if(is.numeric) %>%  # Select only numeric variables
  na.omit()%>%  # Remove rows with missing values
  relocate(total_rider_tran, .before = total_rider_bike)
ggpairs(numericVars)

summary(final_19_total_acs)

## Add log
numericVars.log <- numericVars%>%
  mutate(log.total_rider_tran = log(total_rider_tran+1),
         log.total_rider_bike = log(total_rider_bike+1),
         log.bike.share = log(bike.share+1),
         log.job = log(job+1),
         log.job.den = log(job.den+1),
         log.nearest_bike = log(nearest_bike))%>%
  select(-total_rider_tran, -total_rider_bike, -job, -job.den, -nearest_bike, -bike.share)%>%
  relocate(log.total_rider_tran, .before = total_docks)
ggpairs(numericVars.log)

colnames(numericVars.log)
```

Initial Variable Selection:
- "total_rider_tran" (log)
- "total_rider_bike" (log)
- "bus_stop"
- "pop.den"             
- "commuter.tot"
- "white.share"
- "bike.share" (log)
- "tran.share"
- "job.den" (log) 
- "veh.ownership"
- "medInc"                   
- "employ.rate"

```{r step2}
summary(final_19_total_acs)

mod.1 <- lm(log(total_rider_tran) ~ log(total_rider_bike + 1) + bus_stop + pop.den + commuter.tot + log(job.den + 1) + white.share + log(bike.share + 1) + tran.share + veh.ownership + medInc + employ.rate, data = final_19_total_acs)
summary(mod.1)
vif(mod.1)

## delete variable from the one with the largest p-value
mod.2 <- lm(log(total_rider_tran) ~ log(total_rider_bike + 1) + bus_stop + pop.den + commuter.tot + log(job.den + 1) + white.share + log(bike.share + 1) + tran.share + veh.ownership + employ.rate, data = final_19_total_acs)
summary(mod.2) ## medInc
vif(mod.2)

mod.3 <- lm(log(total_rider_tran) ~ log(total_rider_bike + 1) + bus_stop + pop.den + commuter.tot + log(job.den + 1) + white.share + log(bike.share + 1) + tran.share + veh.ownership, data = final_19_total_acs)
summary(mod.3) ## employ.rate

mod.4 <- lm(log(total_rider_tran) ~ log(total_rider_bike + 1) + bus_stop + pop.den + commuter.tot + white.share + log(bike.share + 1) + tran.share + veh.ownership, data = final_19_total_acs)
summary(mod.4) ## log(job.den + 1)

mod.5 <- lm(log(total_rider_tran) ~ log(total_rider_bike + 1) + bus_stop + pop.den + commuter.tot + white.share + log(bike.share + 1) + tran.share, data = final_19_total_acs)
summary(mod.5) ## veh.ownership
```

## Multiple Regression with Time Period (Interaction Term)

```{r step4}
mod.6 <- lm(log(hour_rider_tran + 1) ~ log(hour_rider_bike + 1)*time_period_cat + bus_stop + pop.den + commuter.tot + white.share + log(bike.share + 1) + tran.share, data = final_19_period_acs)
summary(mod.6)
plot(mod.6)
```

