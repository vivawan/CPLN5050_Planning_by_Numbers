---
title: "Final Assignment"
author: "Viva/Yaohan"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: flatly
    toc_float: yes
    code_folding: hide
    number_sections: no
  pdf_document:
    toc: yes
---

<style>
.kable thead tr th, .table thead tr th {
  text-align: left !important;}
table.kable, table.table {
  width: 100% !important;}
  body {
  line-height: 1.6;
  font-size: 16px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dpi = 150)
options(scipen = 999)

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(tidyverse, sf, units, nngeo, tmap, tinytex, kableExtra, janitor, classInt,
       patchwork, here, tidycensus, lwgeom, lsr, haven, descr, RColorBrewer, stargazer,
       car, FNN, GGally, MASS, ISLR2, spdep, caret, ckanr, grid, gridExtra, ggcorrplot,
       jtools, broom, tufte, rmarkdown, corrr, RSocrata, viridis, spatstat, raster, knitr,
       arm, mlogit, readxl, lubridate)

library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::recode)
conflicts_prefer(sf::st_crs)
```

# Data Preparation

1. Transit Data
- Transit Ridership
MBTA Rail Ridership by Time Period, Season, Route/Line, and Stop: https://mbta-massdot.opendata.arcgis.com/search?tags=ridership
The data is for Fall2019, Fall2018, and Fall2017. Since Fall2018 only has data for September, so we only use ridership data for Fall2019 and Fall2017.
MBTA Gated Station Entries: https://mbta-massdot.opendata.arcgis.com/datasets/7859894afb5641ce91a2bb03599fdf5b/about

- Transit Station
MBTA Rapid Transit: https://www.mass.gov/info-details/massgis-data-mbta-rapid-transit#downloads-
Name and location for each transit stopï¼› Combined with ridership data.

- Definition for "Fall" in MassDOT
Important Work Restrictions for massDOT: https://www.mass.gov/doc/controls-guidelines-attachment-a-important-work-restrictions/download
The Fall season defined by MassDOT is from August.15 to November.1, so we use bike data for August, September and October.

2. Bike Data
- Bike ridership
Blue Bikes Comprehensive Trip Histories: https://s3.amazonaws.com/hubway-data/index.html
2017: August, September, October
2019: August, September, October

- Bike Station
Bluebikes Stations: https://bluebikes.com/system-data

3. Bus Data
- Bus Ridership
MBTA Bus Ridership by Trip, Season, Route/Line, and Stop: (Silver Line?) https://mbta-massdot.opendata.arcgis.com/datasets/fc95594660634a2fb1a7c6c550f13ef5_0/explore

- Bus Stop
MBTA Bus Routes and Stops: https://www.mass.gov/info-details/massgis-data-mbta-bus-routes-and-stops?_gl=1*1iy371g*_ga*MTQzMTUzMDg3Mi4xNzA4MTExODY2*_ga_MCLPEGW7WM*MTcxMzg4OTY1OC4xLjEuMTcxMzg4OTY4MS4wLjAuMA..#overview-

4. Demographic Data
https://www.bostonplans.org/3d-data-maps/resources
https://data.census.gov/

5. Other Data
- MBTA Boundary
MBTA Core Service Area: https://mbta-massdot.opendata.arcgis.com/search?q=boundary

## Import Datasets

```{r load_data, message = FALSE, warning = FALSE}
# Transit Data
## Transit Ridership
tran_rider <- read_csv(here::here("data/final/Transit_Ridership.csv"))
## Transit Station
tran_line <- st_read(here::here("data/final/mbta_rapid_transit/MBTA_ARC.shp"))
tran_stop <- st_read(here::here("data/final/mbta_rapid_transit/MBTA_NODE.shp"))


# Bike Data
## Bike Ridership
bike_rider_17_aug <- read_csv(here::here("data/final/201708-hubway-tripdata.csv"))
bike_rider_17_sep <- read_csv(here::here("data/final/201709-hubway-tripdata.csv"))
bike_rider_17_oct <- read_csv(here::here("data/final/201710-hubway-tripdata.csv"))
bike_rider_19_aug <- read_csv(here::here("data/final/201908-bluebikes-tripdata.csv"))
bike_rider_19_sep <- read_csv(here::here("data/final/201909-bluebikes-tripdata.csv"))
bike_rider_19_oct <- read_csv(here::here("data/final/201910-bluebikes-tripdata.csv"))
## Bike Station
bike_stop <- read_csv(here::here("data/final/current_bluebikes_stations.csv"))


# Bus Data



# Demographic Data
## Load census tract data
census_api_key("3ec2bee8c227ff3f9df970d0ffbb11ee1384076e", install = TRUE, overwrite = TRUE)

acs_variable_list.2017 <- load_variables(2017, # Year
                                         "acs5", # Five year ACS estimates
                                         cache = TRUE)

acs_variable_list.2019 <- load_variables(2019, # Year
                                         "acs5", # Five year ACS estimates
                                         cache = TRUE)


# Other Data
## MBTA Boundary
mbta_core <- st_read(here::here("data/final/Core_Service_Area/Core_Service_Area.shp"))
```

## Data Wrangling

```{r data_clean}
# Transit Data
## Align Station Name between Two Datasets
tran_rider <- tran_rider %>%
  mutate(stop_name = case_when(
    stop_name == "Back of the Hill" ~ "Back Of The Hill",
    stop_name == "Boston Univ. Central" ~ "Boston University Central",
    stop_name == "Boston Univ. East" ~ "Boston University East",
    stop_name == "Boston Univ. West" ~ "Boston University West",
    stop_name == "Chestnut Hill Ave." ~ "Chestnut Hill Avenue",
    stop_name == "Englewood Ave." ~ "Englewood Avenue",
    stop_name == "Harvard Ave." ~ "Harvard Avenue",
    stop_name == "JFK/Umass" ~ "JFK/UMass",
    stop_name == "Massachusetts Ave." ~ "Massachusetts Ave",
    stop_name == "Museum of Fine Arts" ~ "Museum Of Fine Arts",
    stop_name == "Northeastern University" ~ "Northeastern",
    stop_name == "Saint Mary Street" ~ "Saint Marys Street",
    stop_name == "Science Park" ~ "Science Park/West End",
    stop_name == "State Street" ~ "State",
    stop_name == "Summit Ave." ~ "Summit Avenue",
    TRUE ~ stop_name))

name_rider <- unique(tran_rider$stop_name)
name_stop <- tran_stop$STATION
not_in_station <- as.data.frame(setdiff(name_rider, name_stop))

## Transit Station

## Transit Ridership
tran_rider_17 <- tran_rider %>%
  filter(season == "Fall 2017")

tran_rider_19 <- tran_rider %>%
  filter(season == "Fall 2019")


# Bike Data
## Bike Station
colnames(bike_stop) <- as.character(unlist(bike_stop[1, ]))
bike_stop <- bike_stop[-1, ] %>%
  select(Name = NAME,
         Total_Docks = `Total Docks`)

## Combine 2017
bike_rider_17 <- bind_rows(bike_rider_17_aug, bike_rider_17_sep, bike_rider_17_oct)
sum(duplicated(bike_rider_17))

### Start Trips
bike_rider_17_start <- bike_rider_17 %>%
  group_by(`start station name`) %>%
  summarise(Start_Trip_17 = n()) %>%
  rename(Name = `start station name`)

### End Trips
bike_rider_17_end <- bike_rider_17 %>%
  group_by(`end station name`) %>%
  summarise(End_Trip_17 = n()) %>%
  rename(Name = `end station name`)

### 2017 Bike Stops
sum(bike_rider_17_start$Name %in% bike_rider_17_end$Name)
bike_stop_17 <- bike_rider_17 %>%
  select(Name = `start station name`,
         Long = `start station longitude`,
         Lat = `start station latitude`) %>%
  group_by(Name, Long, Lat) %>%
  tally() %>%
  ungroup() %>%
  select(-n) %>%
  distinct(Name, .keep_all = TRUE) %>%
  filter(Lat != 0 & Long != 0)

### 2017 Total Trips
bike_rider_17 <- bike_rider_17_start %>%
  left_join(., bike_rider_17_end, by = "Name") %>%
  mutate(Bike_Rider_17 = Start_Trip_17 + End_Trip_17) %>%
  left_join(bike_stop_17, ., by = "Name") %>%
  filter(!is.na(Bike_Rider_17)) %>%
  st_as_sf(coords = c("Long", "Lat"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(Name, Bike_Rider_17) %>%
  left_join(., bike_stop, by = "Name") %>%
  mutate(Total_Docks = as.numeric(Total_Docks)) %>%
  mutate(Total_Docks = replace_na(Total_Docks,
                                  floor(mean(Total_Docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(Total_Docks, .before = geometry)

## Combine 2019
bike_rider_19 <- bind_rows(bike_rider_19_aug, bike_rider_19_sep, bike_rider_19_oct)
sum(duplicated(bike_rider_19))

### Start Trips
bike_rider_19_start <- bike_rider_19 %>%
  group_by(`start station name`) %>%
  summarise(Start_Trip_19 = n()) %>%
  rename(Name = `start station name`)

### End Trips
bike_rider_19_end <- bike_rider_19 %>%
  group_by(`end station name`) %>%
  summarise(End_Trip_19 = n()) %>%
  rename(Name = `end station name`)

### 2019 Bike Stops
sum(bike_rider_19_start$Name %in% bike_rider_19_end$Name)
stop_17 <- unique(bike_rider_17$Name)
bike_stop_19 <- bike_rider_19 %>%
  select(Name = `end station name`,
         Long = `end station longitude`,
         Lat = `end station latitude`) %>%
  group_by(Name, Long, Lat) %>%
  tally() %>%
  ungroup() %>%
  select(-n) %>%
  distinct(Name, .keep_all = TRUE) %>%
  filter(Lat != 0 & Long != 0) %>%
  mutate(New_Stop = ifelse(Name %in% stop_17, 0, 1))
table(bike_stop_19$New_Stop)

### 2019 Total Trips
bike_rider_19 <- bike_rider_19_start %>%
  left_join(., bike_rider_19_end, by = "Name") %>%
  mutate(Bike_Rider_19 = Start_Trip_19 + End_Trip_19) %>%
  left_join(bike_stop_19, ., by = "Name") %>%
  filter(!is.na(Bike_Rider_19)) %>%
  st_as_sf(coords = c("Long", "Lat"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(Name, Bike_Rider_19, New_Stop) %>%
  left_join(., bike_stop, by = "Name") %>%
  mutate(Total_Docks = as.numeric(Total_Docks)) %>%
  mutate(Total_Docks = replace_na(Total_Docks,
                                  floor(mean(Total_Docks, na.rm = TRUE)))) %>% # Use mean to replace NA, can also use 0
  relocate(Total_Docks, .before = geometry)

rm(list = setdiff(ls(), c("tran_line", "tran_stop", "tran_rider_17", "tran_rider_19",
                          "bike_rider_17", "bike_rider_19", "mbta_core")))


# Demographic Data
## Select Variables
acs_vars_17 <- c("B01003_001E", # Total population
                 ) 

acs_vars_19 <- c("B01003_001E", # Total population
                 )

## 2017
acsTracts_2017 <- get_acs(geography = "tract",
                             year = 2017, 
                             variables = acs_vars_17,
                             geometry = TRUE,
                             state = "Massachusetts",
                             output = "wide") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(GEOID, NAME, all_of(acs_vars_17)) %>%
  rename(total_pop = B01003_001E)

## 2019
acsTracts_2019 <- get_acs(geography = "tract",
                             year = 2019, 
                             variables = acs_vars_19,
                             geometry = TRUE,
                             state = "Massachusetts",
                             output = "wide") %>%
  st_transform(st_crs(tran_stop)) %>%
  select(GEOID, NAME, all_of(acs_vars_19)) %>%
  rename(total_pop = B01003_001E)


# Other Data
## MBTA Boundary
mbta_core <- mbta_core %>%
  st_transform(st_crs(tran_stop)) %>%
  st_union() %>%
  st_as_sf()
```



